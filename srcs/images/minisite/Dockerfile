## Go builder stage
FROM alpine:3.12.7 as go-builder

# go setup
RUN apk add go=1.13.15-r0

WORKDIR /app

# copy source code and compile
COPY . .
RUN go build -ldflags "-w -s" .


## Node builder stage
FROM alpine:3.12.7 as node-builder

WORKDIR /app

RUN apk add nodejs=12.22.1-r0 npm=12.22.1-r0

COPY ./resources/slides .

RUN npm install
RUN npm run build


## Final stage
FROM alpine:3.12.7 as final

LABEL maintainer="aguiot--@student.42.fr"

WORKDIR /app

# copy compiled binary file from go-builder
COPY --from=go-builder /app/minisite ./minisite

# copy config and resources (assets)
COPY config.production.json ./config.production.json
COPY resources ./resources

# copy SPA generated by Slidev (slides)
COPY --from=node-builder /app/dist/* ./resources/static/slides/

# user setup
RUN adduser -S -H go-exec -s /bin/false
RUN chown -R go-exec /app
USER go-exec

EXPOSE 80/tcp

ENV GOYAVE_ENV=production

ENTRYPOINT ["./minisite"]
